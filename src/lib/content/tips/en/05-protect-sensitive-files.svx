
Claude Code reads `.env`, `.env.local`, and similar files without asking permission. Your API keys and database passwords get sent to Anthropic's servers before you realize it happened. This isn't a bug. It's the default behavior.

[GitHub found 39 million leaked secrets](https://github.blog/security/application-security/next-evolution-github-advanced-security/) across public repositories in 2024. AI coding tools are accelerating this problem. [Research from Apiiro](https://apiiro.com/blog/4x-velocity-10x-vulnerabilities-ai-coding-assistants-are-shipping-more-risks/) shows AI-assisted developers exposed Azure Service Principals and Storage Access Keys nearly twice as often as non-AI peers.

## Files at Risk

These files contain secrets Claude can read by default:

| File Pattern | What It Contains |
|--------------|------------------|
| `.env`, `.env.*` | API keys, database URLs, service credentials |
| `.env.local`, `.env.production` | Environment-specific secrets |
| `~/.ssh/**` | SSH private keys for server access |
| `~/.aws/credentials` | AWS access keys and secret keys |
| `**/*.pem`, `**/*.key` | SSL certificates, private keys |
| `**/secrets/**` | Any secrets directory |
| `.envrc` | direnv environment variables |
| `**/credentials.json` | Service account credentials |
| `**/.gcloud/**` | Google Cloud credentials |

If Claude reads your `.env` file and later suggests code that references those values, your secrets could end up in a commit, a log, or worse, sent to a third-party API.

## Layer 1: Permission Deny Rules

Add deny rules to `~/.claude/settings.json` for global protection across all projects:

```json
{
  "permissions": {
    "deny": [
      "Read(./.env)",
      "Read(./.env.*)",
      "Read(./secrets/**)",
      "Read(**/*.pem)",
      "Read(**/*.key)",
      "Read(**/.aws/**)",
      "Read(**/.ssh/**)",
      "Read(**/.gcloud/**)",
      "Read(**/credentials.json)"
    ]
  }
}
```

For project-specific rules, use `.claude/settings.json` in your repo root. For personal overrides not committed to git, use `.claude/settings.local.json`.

**Settings precedence (highest to lowest):**
1. Remote managed settings (via Claude.ai admin console)
2. File-based managed settings (`managed-settings.json`)
3. Command line arguments
4. Local project settings (`.claude/settings.local.json`)
5. Shared project settings (`.claude/settings.json`)
6. User settings (`~/.claude/settings.json`)

**Warning about deny rules:** Deny rules [have had bugs](https://github.com/anthropics/claude-code/issues/6699) where they weren't enforced. The issue was closed as fixed, but subsequent reports suggest inconsistent behavior persists. Always verify your rules actually work (see "Verify Your Configuration" below). Don't rely on deny rules as your only protection.

## Layer 2: Block Bash Commands Too

Denying Read isn't enough. Claude can still run `cat .env` or `grep API_KEY .env` through Bash. Add these to your deny list:

```json
{
  "permissions": {
    "deny": [
      "Read(./.env*)",
      "Bash(cat:*/.env*)",
      "Bash(cat:*.pem)",
      "Bash(cat:*.key)",
      "Bash(grep:*/.env*)",
      "Bash(head:*/.env*)",
      "Bash(tail:*/.env*)",
      "Bash(less:*/.env*)",
      "Bash(more:*/.env*)"
    ]
  }
}
```

Note: Bash rules use prefix matching, not regex. And denying Read doesn't block Write or Edit. Claude could still overwrite your `.env` file. Add `Edit(./.env*)` to your deny list if you want complete protection.

## Layer 3: CLAUDE.md Instructions

Belt and suspenders. Even with deny rules, add explicit instructions to `CLAUDE.md`:

```markdown
## Security Rules

- NEVER read, reference, or output contents of .env files
- NEVER include real API keys, tokens, or credentials in code or responses
- Use placeholder values like "YOUR_API_KEY" or "sk-xxx" instead
- NEVER copy .env contents to other files like .env.example
- If you need environment variable names, ask me. Don't read the file.
```

Claude follows instructions. If told not to attempt something, it usually won't try. This catches cases where deny rules might have gaps.

## Layer 4: Hooks

For critical security, use [PreToolUse hooks](https://code.claude.com/docs/en/hooks) to intercept and block operations before they execute. Here's a minimal example:

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Read",
        "hooks": [
          {
            "type": "command",
            "command": "python3 ~/.claude/scripts/block-secrets.py"
          }
        ]
      }
    ]
  }
}
```

The script checks if the file path matches sensitive patterns and exits with code 2 to block the operation. The error message in stderr gets fed back to Claude.

**Known issue:** PreToolUse hooks with exit code 2 [don't block Write/Edit operations](https://github.com/anthropics/claude-code/issues/13744) reliably. The Bash tool works correctly, but Write and Edit may proceed despite the hook returning exit 2. For Write/Edit protection, use deny rules or PostToolUse hooks to detect violations after the fact.

Hooks are covered in depth in Tip 40. Check there for complete examples.

## Layer 5: Sandbox (Maximum Security)

[Claude Code's sandbox](https://code.claude.com/docs/en/sandboxing) uses OS-level enforcement. On Linux, it's Bubblewrap (same tech as Flatpak). On macOS, it's Seatbelt (same tech as iOS apps). The kernel blocks access, not just Claude's internal rules.

Run `/sandbox` to enable it. In auto-allow mode, bash commands run inside the sandbox automatically. Commands that need network access to non-allowed hosts fall back to the regular permission flow.

With Docker, use [Docker's sandbox integration](https://docs.docker.com/ai/sandboxes/claude-code/):

```bash
docker sandbox run claude
```

This gives you complete isolation. Your SSH keys, AWS credentials, and shell config are invisible, not just blocked, but nonexistent from Claude's perspective. Even successful prompt injection attacks can't bypass OS-level sandboxing.

Configure sandbox network and filesystem boundaries in settings:

```json
{
  "sandbox": {
    "network": {
      "httpProxyPort": 8080,
      "socksProxyPort": 8081
    }
  }
}
```

Set `"allowUnsandboxedCommands": false` to prevent Claude from escaping the sandbox with `dangerouslyDisableSandbox`.

## Critical Warning: File Deletion

If a file is:
- NOT tracked in git, AND
- NOT explicitly denied in settings

Claude can delete it. Permanently. No undo button.

[SSDs with TRIM enabled](https://blog.elcomsoft.com/2025/06/what-trim-drat-and-dzat-really-mean-for-ssd-forensics/) zero freed blocks almost immediately. Deterministic Zero After TRIM (DZAT) means read commands return zeros until new data is written. Recovery tools can't help once TRIM has run.

Real incidents from 2025:
- Claude [ran `git checkout` without authorization](https://github.com/anthropics/claude-code/issues/11237), destroying 4 days of uncommitted work
- Claude deleted entire directories while "cleaning up"
- Claude copied `.env` to `.env.example` and pushed to GitHub

**Protection:** Commit everything important to git. Push frequently. Keep secrets outside project directories when possible.

## Verify Your Configuration

Test your deny rules actually work:

1. Ask Claude to read your `.env` file directly
2. Ask Claude to run `cat .env`
3. Ask Claude to describe what's in your secrets directory

If any of these succeed, your configuration has gaps. Fix them before doing real work.

Check your current permissions with the `/permissions` command. It shows all active rules and their source files.

## Quick Reference

| Layer | Protects Against | Configuration |
|-------|-----------------|---------------|
| Deny rules (Read) | Direct file reads | `permissions.deny` in settings.json |
| Deny rules (Bash) | Shell commands like `cat` | Add `Bash(cat:*)` patterns |
| CLAUDE.md | Instruction-following bypass | Security section in CLAUDE.md |
| PreToolUse hooks | File access attempts (Bash only reliable) | Script with exit 2 |
| Sandbox | Everything including prompt injection | `/sandbox` or Docker |

Use at least layers 1-3. Add layer 4 for sensitive projects. Use layer 5 for maximum security or untrusted environments.

Treat Claude like a powerful but untrusted contractor. Give it minimum necessary access. Verify it cannot reach your secrets. Assume any file it can read might end up somewhere you don't want it.
